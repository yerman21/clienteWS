<html>
<head>
	<title>Login</title>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js" type="text/javascript"></script>
	<script src="https://www.gstatic.com/firebasejs/6.4.0/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/6.4.0/firebase-firestore.js"></script>
</head>
<body>
	<form id="formTest" action="/" method="post">
		<input type="text" id="user_name" name="user_name" placeholder="UserName" required>
		<input type="password" id="pass" name="pass" placeholder="Password" required>
		<input type="submit" value="Loguearce">
	</form>
	<div id="message"></div>
	<script type="text/javascript">
	
	$(document).ready(function(){
		$("#formTest").on("submit", function(event){
 			event.preventDefault();
			$.post( "/",{
	 			user_name: $("#user_name").val(),
	 			pass: $("#pass").val()
	 		})
	 		.then(function(result, textStatus, jqXHR) {
	 			console.log(result);
	 			console.log(jqXHR);
	 			if(jqXHR.status != 200){
	 				$("#message").html(result);
	 				return;
	 			}
	 			$("#message").html("<h2>Confirma el acceso desde tu movil. Esperando...</h2>");
	 			waitChange(result.user_name)
	 		});
 		});

		function waitChange(user_name){
			var config = {
				databaseURL: "https://factorauthapp-23dc4.firebaseio.com",
				projectId: "factorauthapp-23dc4"
			};
			firebase.initializeApp(config);
			const db = firebase.firestore().collection("UserSession").doc(user_name).onSnapshot(function(doc) {
		        	doc = doc.data();
		        	if(doc.auth_band == true){
		        		confirmChange(user_name);
		        	}
		    });
		    setTimeout(function(){
		    	confirmChange(user_name)
		    }, 10000);
		}
	});

		function confirmChange(user_name){
 			var form = document.createElement("form");
		    var element1 = document.createElement("input");

		    form.method = "POST";
		    form.action = "/validateAuth";   

		    element1.value = user_name;
		    element1.name = "user_name";
		    form.appendChild(element1);

		    document.body.appendChild(form);
		    form.submit();
		}

	</script>
</body>
</html>